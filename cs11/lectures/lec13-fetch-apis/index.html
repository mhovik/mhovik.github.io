<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Lecture 13: Using fetch with APIs</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="../../site/reveal/css/reveal.css">
    <link rel="stylesheet" href="../../site/reveal/css/theme/white.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../site/reveal/lib/css/color-brewer.css">
    <link rel="stylesheet" href="../../site/reveal/css/154-override.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? '../../site/reveal/css/print/pdf.css' :
      '../../site/reveal/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>
	<body>
		<div class="reveal">
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
        <section>
          <h2>Lecture 13</h2>
          <h3>Using fetch with APIs</h3>
        </section>
        <section>
          <h2>Agenda</h2>
          <p><a href="https://gitlab.cs.washington.edu/cse154-19su-students/hw3-pokedex" target="_blank">HW3 Part A</a> Due Friday</p>
          <p>Brief review of Promises/AJAX</p>
          <p>Using fetch with public APIs</p>
        </section>
        <section>
          <h2>JSON and AJAX</h2>
          <ul>
            <li>JSON introduced as object type to package/process structured data</li>
            <li>AJAX introduced with Promises and <code>fetch</code> to fetch data from a server</li>
            <li>Used the <code>fetch(URL).then(...).then(...).catch(...)</code> pipeline
              to handle requests (yesterday)</li>
          </ul>
        </section>
        <section>
          <h2>
            AJAX <code>fetch</code> template
          </h2>
          <p class="font-20pt">
            When we make a call to fetch data (whether it's HTML, txt, JSON, etc) we use a
            function in JavaScript called <code>fetch</code>, which takes a URL path to
            fetch data from.
          </p>
          <p class="font-20pt">
            Here's the general template you will use for most AJAX code:
          </p>
          <pre class="h400px"><code class="hljs font-12pt" data-trim>const BASE_URL = ""; // you may have more than one

// Step 1. Write a function to "fetch" data from a URL
function makeRequest() {
  let url = BASE_URL + "?query0=value0"; // some requests require parameters
  fetch(url)
    .then(checkStatus)
    //.then(resp => resp.text()) // include if your data comes in text
    //.then(resp => resp.json()) // include if your data comes in JSON
    .then(processData)
    .catch(handleError); // define a user-friendly error-message function
}

// Step 2: Implement a function to process the response data. You may want to break this apart
// into multiple functions.
function processData(responseData) {
  // Do something with your responseData! (build DOM, display messages, etc.)
}

// Step 3. Include the checkStatus function
function checkStatus(response) {
  if (!response.ok) { // response.status &gt;= 200 &amp;&amp; response.status &lt; 300
     throw Error("Error in request: " + response.statusText);
  }
  return response;
}</code></pre>
          <p class="code-caption space-above">JS</p>
        </section>
        <section>
          <h2>Promises and Fetch</h2>
          <p>We initiate a <code>fetch</code> of a URL</p>
          <p>A <code>fetch</code> returns a <code>Promise</code></p>
          <p>Promises are good because... </p>
          <ul>
              <li>They help deal with code that has an uncertain outcome</li>
              <li>They separate the completion of the fetch request from the page logic
                <ul>
                  <li>
                    Lets us reuse the same logic and handle completion in different
                    ways (AJAX logic vs page insertion, for example)
                  </li>
                </ul>
              </li>
              <li>Chaining of Promises gives us a nice data flow, like down a pipe!</li>
          </ul>
       </section>

        <section>
          <h2>States of a Promise</h2>
          <img src="../img/promise-states.jpg" alt="Three states of a Promise: pending, resolved, rejected" />
        </section>
              <section>
              <h2>Using Promises with <code>fetch</code></h2>
              <p>
                We won't be constructing Promises, but will be using them when we <code>fetch</code> information from a
                server, which is an uncertain task
              </p>
              <p>
                The returned <code>Promise</code> contains a value that is a <code>Response</code> from the requested resource,
                which we can get <code>then.</code> after the fetch call.
              </p>
              <pre><code class="hljs">fetch(url).then((resp) =&lt; {
    // resp is a Response object!
});</code></pre>
              <p class="code-caption">JS</p>
              <p>
                What's in a <code>Response</code>?
              </p>
            </section>
            <section class="font-16pt-slide">
              <h2>The <code>Response</code> object</h2>
            <table class="code-table med-font-table">
              <tr>
                <th>Property</th>
                <th>Description</th>
              </tr>
              <tr>
                <td>response.status</td>
                <td>Status code (e.g. 200, 400, etc.)</td>
              </tr>
              <tr>
                <td>response.ok</td>
                <td>Whether the response has a success (2XX) status code, short for:<br>
                  <samp>response.status > 200 && response.status <= 300</samp>)</td>
              </tr>
              <tr>
                <td>response.statusText</td>
                <td>Status text returned in the response (e.g. "200 OK", "400 Bad Request", "503 Service Unavailable")</td>
              </tr>
              <tr>
                <td>response.json(), response.text()</td>
                <td>Methods to extract the response body depending on the data format</p>
              </tr>
            </table>
              <p>We will use the Response returned (in a Promise) from <code>fetch</code> to:</p>
              <ol>
                <li>Check <code>response.ok</code></li>
                <li>If not, throw an Error which will jump immediately to a <code>catch</code> statement. It's good
                to construct the Error with details about the <code>response.statusText</code></li>
                <li>Otherwise, extract the data we want with <code>response.text()</code> or <code>response.json()</code></li>
              </ol>
            </section>
            <section>
              <h2>Recall Status Codes</h2>
              <p>Set by the server</p>
              <p>A 2XX status code (e.g. 200, 201, etc.) will indicate a successful request</p>
              <p>Other status codes indicate a failure in the request</p>
              <ul>
                <li>3XX: Redirects</li>
                <li>4XX: Client errors (400: Bad Request, 403: Forbidden, etc.)</li>
                <li>5XX: Server errors</li>
              </ul>
              <p>Full list <a href="https://www.restapitutorial.com/httpstatuscodes.html" target="_blank">here</a></p>
              <p>We can access the status code and status text with the Response object</p>
              <p>This is a useful service to test different error codes: <a href="https://httpstat.us/" target="_blank">https://httpstat.us/</a></p>
              <p>Demo: <a href="code/status-tester.html" target="_blank">status-tester.html</a></p>
            </section>
          <section>
            <h2>Why AJAX?</h2>
            <p>Recall our earlier Cafe Demo</p>
            <p><a href="code/cse154-cafe/index-original.html" target="_blank">Version 1</a> (HTML): Menu in HTML</p>
            <p><a href="code/cse154-cafe/menu-populator-local-json.js" target="_blank">Version 2</a> (JS): Menu in JSON as local variable in JS</p>
            <p><a href="code/cse154-cafe/index-with-fetch.html" target="_blank">Version 3</a>: Let's use fetch with the JSON on a server!</p>
          </section>
          <section>
          <h2>Application Program Interfaces (APIs)</h2>
          <p>
            An application programming interface (API) is a communication protocols that
            allows two pieces of software to communicate.
          </p>
          <div class="side-by-side">
          <p>
            A Web API is a set of pre-defined URLs with parameters that allow a user to get
            information from a web server. Can be used by many types of clients.
          </p>
          <div>
          <img src="https://happycoding.io/tutorials/java-server/images/rest-api-1.png" class="centered-figure" alt="API diagram" />
          <p class="citation">Source: <a href="https://happycoding.io/tutorials/java-server/rest-api">https://happycoding.io/tutorials/java-server/rest-api</a></p>
        </div>
        </div>
      </section>
      <section>
        <h3>The Client-Server Model</h3>
        <img src="https://clevertechie.com/img/main/REST-representational-state-transfer.png" style='width: 80%' class='centered-figure' alt="REST diagram" />
      </section>
      <section>
        <h3>The Request/Response Transaction with Web APIs</h3>

        <img src="https://i.ytimg.com/vi/LooL6_chvN4/maxresdefault.jpg" class="centered-figure" style='width: 80%' alt="REST API diagram" />
        <p>Much like the request/response analogy at a restaurant!</p>

      </section>
      <section>
        <h2>Examples of APIs</h2>
        <ul>
          <li><a href="https://courses.cs.washington.edu/courses/cse154/webservices/pizzeria/pizzas.php?mode=text" target="_blank">Pizzeria API</a></li>
          <li><a href="https://courses.cs.washington.edu/courses/cse154/19su/sections/week05-tues/slides/#/10/1" target="_blank">Numbers API</a></li>
          <li><a href="https://api.nasa.gov/api.html#apod" target="_blank">NASA APOD API</a></li>
          <li><a href="https://github.com/reddit-archive/reddit/wiki/JSON" target="_blank">Reddit</a></li>
          <li><a href="https://www.ncdc.noaa.gov/cdo-web/" target="_blank">NOAA Climate Data</a></li>
          <li><a href="https://xkcd.com/json.html" target="_blank">XKCD</a></li>
          <li><a href="https://elephant-api.herokuapp.com/" target="_blank">Elephants... API?</a></li>
          <li><a href="https://gitlab.cs.washington.edu/cse154-19su-students/cp3-ajax" target="_blank">6 APIs to choose from on CP3</a></li>
        </ul>
      </section>
   <section>
     <h2>Fetching data from a web service</h2>
     <p>To make a request to a web service (API), we need to know:</p>
     <ol class="font-18pt">
       <li>Who to ask (the url)
         <ul class="fragment">
           <li>Example:
             <a
         href="https://courses.cs.washington.edu/courses/cse154/webservices/cse154-cafe/menu.php">https://courses.cs.washington.edu/courses/cse154/webservices/cse154-cafe/menu.php</a></li>
           <li>Example: <a href="http://numbersapi.com">http://numbersapi.com</a></li>
         </ul>
       </li>
       <li>Do we have permission to ask (any API keys/tokens)
         <ul class="fragment">
           <li>Not in <samp>menu.php</samp>, but NASA/TMDB require them; add as additional query parameter</li>
         </ul>
       <li>What to ask (any query parameters)
         <ul class="fragment">
           <li>Differ per API, some have specific order of parameter values,
             separated by /, others have explicit key/value pairs started with ? and
             combined with &amp;
           </li>
           <li>Example: A Recipes API might have
             <br>
             <samp>recipe.php?recipe=cupcake&amp;vegan=true</samp>
           </li>
           <li>Example: <a href="https://courses.cs.washington.edu/courses/cse154/webservices/cse154-cafe/menu.php?menu=cafe-menu">https://courses.cs.washington.edu/courses/cse154/webservices/cse154-cafe/menu.php?menu=cafe-menu</a> (also supports <samp>menu=pizza-menu</samp>)</li>
           <li>Example: Numbers API from last week's section: <a
         href="http://numbersapi.com/154/math" target="_blank">http://numbersapi.com/154/math</a>)
           </li>
         </ul>
       </li>
       <li>What format we get answers in (the response data format, preferrably txt or JSON)</li>
     </ol>
   </section>
        <section>
          <h2>Check your Understanding</h2>
          <p>
            Consider the following request we might make with <code>fetch</code>:
          </p>
          <pre><code class="hljs">function makeRequest() {
  let requestString = "https://api.nasa.gov/planetary/apod?" +
                      "api_key=DEMO_KEY&amp;date=2018-09-30";
  fetch(requestString)
    .then(checkStatus)           // 1
    .then((resp) => resp.json()) // 2
    .then(processData)           // 3
    .catch(handleError);         // 4
}</code></pre>
          <p class="code-caption">JS</p>
          <ol>
            <li>Who are we asking for data from (the base url)?</li>
            <li>What query parameters are we using? What are the values of the parameters?</li>
            <li>What is the purpose of each step (1 through 4)?</li>
          </ol>
        </section>
        <section>
          <h3>Note: Convenient In-browser JSON Formatter</h3>
          <p>
          We're about to dive into how to get started with a public API. The first thing
          you usually want to do is to find a url with query parameters you're interested
          in, and see if you can view it on your browser.
          </p>
          <p>There is a great Chrome
          extension to format nested JSON returned by different API's!</p>
          </p>
          <p>Chrome Extension: <a
           href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc/related?hl=en">JSON
           View</a></p>
        </section>

     <section>
       <h2>Example API Requests</h2>
       <p>
         The following slides provide a few examples of breaking down request URLS for various APIs, starting with the
         NASA APOD API used in the Pre-Check and demonstrated in lecture.
       </p>
     </section>
     <section>
       <section id="apod">
         <h3>API 1: NASA APOD (Astronomy Photo of the Day) API</h3>
         <p>Solution: <a href="code/apod/apod.html" target="_blank">apod.html</a></p>
         <ol>
           <li>What kind of format is the response data? <strong
cla  ss="fragment">JSON</strong></li>
           <li>Do you need an API key? <strong class="fragment">Yes*</strong> <span
                                               class="fragment">*(but you can
                                               make 50 calls per day with "DEMO_KEY" as your api key parameter!</span>
           <li>What is the base url? <strong class="fragment">https://api.nasa.gov/planetary/apod</strong>
           </li>
         </ol>
       </section>
       <section>
         <h3>API 1: NASA APOD (Astronomy Photo of the Day) API</h3>
         <p>Examples:</p>
         <ul>
           <li>Photo of the day data (for current day):
             <a href="https://api.nasa.gov/nasa/planetary/apod?api_key=DEMO_KEY">https://api.nasa.gov/nasa/planetary/apod?api_key=DEMO_KEY</a>
           </li>
           <li>Photo of the day data (for a given date):
             <a href="https://api.nasa.gov/nasa/planetary/apod?api_key=DEMO_KEY&date=2018-09-30">https://api.nasa.gov/nasa/planetary/apod?api_key=DEMO_KEY&date=2018-09-30</a>
           </li>
         </ul>
       </section>
     </section>
     <section>
       <section id="reddit">
       <h3>API 2: Reddit</h3>
       <p>Note: Go "down" slides for more</p>
       <ol>
         <li>What kind of format is the response data? <strong class="fragment">JSON</strong></li>
         <li>Do you need an API key? <strong class="fragment">Not always</strong>
           <ul class="fragment">
           <li>Note: You need a key if you are wanting to access/update user-specific
           information on reddit (see documentation). To simply fetch JSON about subreddit posts though, you can just
           append <samp>/.json</samp> to the end of a subreddit url.
           </li>
           </ul>
         </li>
         <li>
           What kind of query parameters can you pass?
           <ul class="fragment">
             <li>limit=<em>postcount</em> (optional): limits the number of JSON objects
             returned in array of subreddit post data
             </li>
             <li>q=<em>query</em> (optional): filters posts based on search query term</li>
           </ul>
         </li>
       </ol>
     </section>
     <section>
       <h2>API 2: Reddit Example</h2>
       <pre><code class='hljs font-12pt' data-no-escape>https://www.reddit.com/r/<em>subreddit</em>/.json?limit=<em>postcount</em></code></pre>
       <p class="code-caption">Template</p>
       <pre><code class='hljs font-12pt'
          data-no-escape>https://www.reddit.com/r/<em>subreddit</em>/search/.json?limit=<em>postcount</em>&q=<em>searchquery</em></code></pre>
       <p class="code-caption">Template</p>
       <p>Examples:</p>
       <ul>
         <li>
           <a href="https://www.reddit.com/r/ProgrammerHumor/.json?limit=1">https://www.reddit.com/r/ProgrammerHumor/.json?limit=1</a>
         </li>
         <li>
           <a href="https://www.reddit.com/r/udub/.json?limit=5">https://www.reddit.com/r/udub/.json?limit=1</a>
         </li>
         <li>
           <a href="https://www.reddit.com/r/aww/.json?limit=1">https://www.reddit.com/r/aww/.json?limit=1</a>
         </li>
         <li>
           <a href="https://www.reddit.com/r/webdev/.json?limit=5">https://www.reddit.com/r/webdev/.json?limit=5</a>
         </li>
         <li>
           <a href="https://www.reddit.com/r/ProgrammerHumor/.json?limit=1">https://www.reddit.com/r/ProgrammerHumor/search/.json?limit=1&q=css</a>
         </li>
       </ul>
     </section>
     <section>
       <h2>API 2: Another Reddit Example</h2>
       <p>
         To get JSON response about best and trending posts on Reddit:
       </p>
       <pre><code class='hljs' data-no-escape>https://www.reddit.com/r/best/.json?limit=<em>postcount</em></code></pre>
       <pre><code class='hljs' data-no-escape>https://www.reddit.com/r/trending/.json?limit=<em>postcount</em></code></pre>
       <p class="code-caption">Template</p>
       <p>Examples:</p>
       <ul>
         <li>
           <a href="https://www.reddit.com/r/best/.json?limit=5">https://www.reddit.com/r/best/.json?limit=5</a>
         </li>
         <li>
           <a href="https://www.reddit.com/r/trending/.json?limit=5">https://www.reddit.com/r/trending/.json?limit=5</a>
         </li>
       </ul>
       <p>More information about JSON data returned: <a href="https://github.com/reddit-archive/reddit/wiki/JSON">Reddit Wiki</a></p>
     </section>
   </section>
   <section>
        <section id="datamuse">
          <h3>API 3: Datamuse API</h3>
         <p>Note: Go "down" slides for more</p>
          <p>An word-querying API: <a href="https://www.datamuse.com/api/">https://www.datamuse.com/api/</a></p>
          <ol>
            <li>What kind of format is the response data? <strong
  class="fragment">JSON</strong></li>
            <li>Do you need an API key? <strong class="fragment">No</strong></li>
            <li>What is the base url? <strong
                                                class="fragment">https://www.api.datamuse.com</strong>
          </ol>
        </section>
        <section>
          <h3>API 3: Datamuse API</h3>
          <p>Examples:</p>
          <ul>
            <li>Words with similar meaning to dog: <a href="https://api.datamuse.com/words?ml=dog">https://api.datamuse.com/words?ml=dog</a></li>
            <li>Words with similar meaning to dog (include definitions as metadata):
              <a href="https://api.datamuse.com/words?ml=dog&md=d">https://api.datamuse.com/words?ml=dog&md=d</a>
            </li>
          </ul>
        </section>
      </section>
      <section>
        <section id="xkcd">
          <h3>API 4: XKCD</h3>
          <p>Note: Go "down" slides for more</p>
          <p>"Documentation": <a href="https://xkcd.com/json.html">https://xkcd.com/json.html</a></p>
          <ol>
            <li>What kind of format is the response data? <strong class="fragment">JSON</strong></li>
            <li>Do you need an API key? <strong class="fragment">No</strong></li>
            <li>What is the base url? <strong class="fragment">https://xkcd.com/</strong>
          </ol>
        </section>
        <section>
          <p>Examples:</p>
          <p>Comic of the Day: <a href="https://xkcd.com/info.0.json">https://xkcd.com/info.0.json</a></p>
        </section>
      </section>
    </section>
  <script src="../../site/reveal/lib/js/head.min.js"></script>
  <script src="../../site/reveal/js/reveal.js"></script>

  <script>
    Reveal.initialize({
      controls: true,
      progress: true,
      history: true,
      center: true,

      transition: 'slide', // none/fade/slide/convex/concave/zoom

      // More info https://github.com/hakimel/reveal.js#dependencies
      dependencies: [{
          src: '../../site/reveal/lib/js/classList.js',
          condition: function() {
            return !document.body.classList;
          }
        },
        {
          src: '../../site/reveal/plugin/markdown/marked.js',
          condition: function() {
            return !!document.querySelector('[data-markdown]');
          }
        },
        {
          src: '../../site/reveal/plugin/markdown/markdown.js',
          condition: function() {
            return !!document.querySelector('[data-markdown]');
          }
        },
        {
          src: '../../site/reveal/plugin/highlight/highlight.pack.js',
          async: true,
          callback: function() {
            hljs.initHighlightingOnLoad();
          }
        },
        { src: '../../site/reveal/plugin/zoom-js/zoom.js', async: true },
        { src: '../../site/reveal/plugin/notes/notes.js', async: true },
        { src: '../../site/reveal/plugin/search/search.js', async: true },
        { src: '../../site/reveal/plugin/print-pdf/printpdfbtn.js', async: true }
      ]
    });
  </script>
</body>
</html>
