<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Browser Storage Technologies</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="../../site/reveal/css/reveal.css">
    <link rel="stylesheet" href="../../site/reveal/css/theme/white.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../site/reveal/lib/css/color-brewer.css">
    <link rel="stylesheet" href="../../site/reveal/css/154-override.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? '../../site/reveal/css/print/pdf.css' :
      '../../site/reveal/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>


  <body>
    <div class="reveal">
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

      <section>
        <h1>Lecture 15 - Cookies</h1>
        <div class="side-by-side">
          <div style="width: 75%">
            <img class="simpleimg" src="img/cookie-monster.png"/>
          </div>
          <div>
            <p style="margin-left: 20px; margin-top: 300px">
              And <code>fetch</code> with POST, <code>localStorage</code>, <code>sessionStorage</code>,
              <code>indexDB</code> and Dexie.... </p>
          </div>
      </section>

        <section>
          <h2>Quick check</h2>
          <p>By the end of today you should be able to decide which of these technologies are best in each situation</p>
          <div class="side-by-side">
            <div class="space-right">
              <ul>
                <li>
                  cookies
                </li>
                <li>
                  localStorage
                </li>
                <li>
                  sessionStorage
                </li>
                <li>
                  indexDB/Dexie
                </li>
              </ul>
            </div>
            <div class="space-left">
              <ul>
                <li>
                  Storing the status a user has successfully logged into a website, but ensuring the log in status is deleted when they close the browser tab.
                </li>
                <li>
                  Keeping track of which emojis are used on the client only.
                </li>
                <li>
                  Storing a value in the browser that is accessible from the server. "
                </li>
                <li>
                  Temporarily retaining large pieces of information that are being downloaded from a website, but most of your users primarily use mobile phones to access the site.
                </li>
              </ul>
            </div>

        </section>

      <section>
        <h2>HTTP and State</h2>
        <p>
          HTTP is a stateless protocol; it
          simply allows a browser to request a
          single document from a web server
        </p>
        <p>
          Once the document has been sent to the client, the server
          does not keep track of any information about what was sent
          (other than maybe in a log file of the transaction).
        </p>
      </section>

      <section>
        <h2>Stateful client/server interaction</h2>
        <p><em>Sites like amazon.com seem to "know
          who I am." How do they do this? How
          does a client uniquely identify itself to
          a server, and how does the server
          provide specific content to each client?
        </em></p>
        <p class="space-above">
          When has this happened to you? What sites were involved?
        </p>
        <p class="space-above">
          Today we'll learn some technologies that are used to store
          "state" on your client machine.
        </p>
        <ul>
          <li>
            Sometimes state is kept simply to aid in the user experience.
          </li>
          <li>
            Sometimes state is passed back to the server from the client... and sometimes that
            happens when you least expect it.
          </li>
        </ul>

      </section>

      <section>
        <h2>Cookies vs. Local Storage</h2>
        <table>
          <tr>
            <th></th>
            <th>Cookies</th>
            <th>Local Storage</th>
          </tr>
          <tr>
            <td>Size</td>
            <td>4kb</td>
            <td>10mb</td>
          </tr>
          <tr>
            <td>Accessible From</td>
            <td>Any window</td>
            <td>Any window</td>
          </tr>
          <tr>
            <td>Expires</td>
            <td>Manually Set</td>
            <td>Never</td>
          </tr>
          <tr>
            <td>Storage Location</td>
            <td>Browser and Server</td>
            <td>Browser Only</td>
          </tr>
          <tr>
            <td>Sent with HTTP Requests</td>
            <td>Yes</td>
            <td>No</td>
          </tr>
        </table>
        <p>Cookies have been around longer than Local/Session Storage</p>
        <p>Different types of cookies (preferences, tracking, etc.) and these are usually smaller</p>
      </section>
      <section>
        <h2>What is a cookie?</h2>
        <ul>
          <li><a href="https://en.wikipedia.org/wiki/HTTP_cookie">cookie</a>: a small amount of information stored within
          the computer browser</li>
          <li>cookies have many uses:
              <ul>
                  <li>authentication</li>
                  <li>user tracking</li>
                  <li>maintaining user preferences, shopping carts, etc.</li>
              </ul>
          </li>
        </ul>
      </section>

      <section>
        <h2>A "tracking cookie"</h2>
        <img src="img/tracking-cookie.png"/>
        <ul>
          <li>an advertising company can put a cookie on your machine when you visit one
          site, and see it when you visit another site that also uses that advertising
          company
          </li>
          <li>therefore they can tell that the same person (you) visited both sites</li>
          <li>can be thwarted by telling your browser not to accept "third-party cookies"</li>
        </ul>
      </section>

      <!--
      <section>
        <h2>Ever-changing web</h2>
        <p>New privacy laws in Europe (<a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation">GDPR</a>)
          are making website owners rethink using cookies
        </p>
        <img style="height: 400px" class="simpleimg" src="img/updatedGDPR.png" alt="updated GDPR notice example">
      </section>
    -->


      <section>
        <h2>How cookies are set and retrieved</h2>
        <ul>
          <li>Client side JS:
              <ul>
                  <li>JavaScript commands can set and retrieved using
                      <code>document.cookie</code></li>
              </ul>
          </li>
          <li>Server Side (Node/Express):
              <ul>
                <li>
                  When the browser requests a page, the server may send back a cookie(s)
                  with it to store on the client
                </li>
                <li>
                  If your server has previously sent any cookies to the browser, the browser
                  will send them back on subsequent requests to remind the server who is connecting
                  to it.
                 </li>
              </ul>
          </li>
        </ul>
      </section>

      <section>
        <h2>Facts about cookies</h2>
        <ul>
          <li>Cookies are only data, not program code.</li>
          <li>Cookies can have set expiration dates.</li>
          <li>Cookies help websites remember who you are (and if you are logged in).</li>
          <li>Cookies CAN be used to track your viewing habits on a particular site.</li>
        </ul>
      </section>
<!--
      <section>
        <h2><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">Cookies in JavaScript:</a> setting</h2>
        <ul>
          <li>To set a cookie use <code>document.cookie = cookieString;</code></li>
          <li><code>cookieString</code> consists of 3 semicolon separated parts (the second two are optional):
            <ul>
              <li>name / value pair. E.g., <code>"lastItemBought=apples"</code></li>
              <li>expiration date (by default when browser closed). E.g., <code>"expires=Thu, 23 May 2018 12:00:00 UTC"</code></li>
              <li>Path where cookie belongs (default is current page). E.g., <code>"path=/"</code></li>
            </ul>
          </li>
          <li>If you set a cookie where the name already has a value, the old value gets overwritten.</li>
        </ul>
        <pre><code data-trim>document.cookie = "lastItemBought=apples; " +
    "expires=Thu, 23 May 2018 12:00:00 UTC; " +
    "path=/";</code></pre>
        <p class="code-caption">JavaScript (example)</p>
      </section>
-->
      <section>
        <h2>Setting/Getting Cookies in Express</h2>
        <p>You can set/send/clear cookies back to the client with the <code>res</code> (Response) object's <code><a href="https://expressjs.com/en/4x/api.html#res.cookie" target="_blank">res.cookie()</a></code> and <code><a href="https://expressjs.com/en/4x/api.html#res.clearCookie" target="_blank">res.clearCookie()</code> functions</p>
        <pre><code>res.cookie(name, value, { expires : new Date(Date.now() + 10000) }); // expires in 10 seconds</code></pre>
        <pre><code>res.cookie(name, value, { maxAge : 10000 }); // also expires in 10 seconds</code></pre>
        <pre><code>res.cookie("logged_in", "true", { maxAge : 10000 });</code></pre>
        <p>You can get the client's cookies using the <code>req</code> (Request) object's <code><a href="https://expressjs.com/en/4x/api.html#req.cookies" target="_blank">req.cookies</a></code> property (an object of key/value pairs).</p>
        <pre><code>console.log(req.cookies); // { logged_in : "true" }</code></pre>
      </section>

      <section>
        <h2><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">Cookies in JavaScript:</a> Retrieving</h2>
        <ul>
          <li>To get a cookie use <code>let cookies = document.cookie;</code></li>
          <li>
            This will return a semicolon separated list of all current name=value pairs<br>
            E.g., <code>"lastItemBought=apples; numberSiteVisitsToday=57"</code></li>
          <li>You have to retrieve the values from the string by parsing yourself.</li>
        </ul>
      </section>

      <section>
        <h2><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">Cookies in JavaScript:</a> Clearing</h2>
        <p>To delete a cookie you need to set it's expiration time to be before now</li>
        </p>
        <pre><code data-trim>document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';</code></pre>
<p class="code-caption">JavaScript (example)</p>
      </section>


      <section>
        <h2>Cookies Recap</h2>
        <ul>
          <li> <del>...delicious, particularly with chocolate chips.</del></li>
          <li> ...are a way to store information or the state of your website.</li>
          <li> ...can be set so they expire after a time, or after you close the page.</li>
          <li> ...are kind of a pain to retreive,
            if there are many cookies that are set already.</li>
          <li> ...they only allow up to only 4 KB of data storage.</li>
          <li> ...they can be used by malicious sites to "spy" on browsing behavior.</li>
        </ul>
    </section>


    <section>
      <h2><code>localStorage</code> and <code>sessionStorage</code></h2>
    </section>

      <section>
        <h2>localStorage and sessionStorage</h2>
        <div class="side-by-side">
          <div style="width: 800px">
            <img class="simpleimg" style="margin-top: 50px; margin-right: 10px" src="https://upload.wikimedia.org/wikipedia/commons/c/c7/Public_Storage_doors.jpg" alt="storage doors">
            <p>From <a href="https://en.wikipedia.org/wiki/File:Public_Storage_doors.jpg">Wikipedia</a></p>
          </div>
          <div>
            <p>
              <code>localStorage</code> is a <code>document</code> property that allows
              you to save information across browser sessions (i.e after you close the browser)
            </p>
            <p>
              <code>sessionStorage</code> is a <code>document</code> property that allows
              you to save information for this session only, and will be cleared when
              the page is closed.
            </p>
            <p>Both <code>localStorage</code> and <code>sessionStorage</code>
              inherit from <code>Storage</code> class.
            </p>
            <p>Name/value pairs (seen in cookies and Storage) are supported by
              <a href="https://caniuse.com/#search=localstorage">most every
                browser</a>
            </p>
          </div>
      </section>

      <section>
        <h2><a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage">Storage</a></h2>
        <p>There are three methods we're interested in from <code>Storage</code> </p>
        <table>
          <tr>
            <th>method</th>
            <th>description</th>
          </tr>
          <tr>
            <td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage/setItem">setItem(keyName, keyValue)</a></td>
            <td>Sets the <code>keyName</code> location in localStorage to be <code>keyValue</code></td>
          </tr>
          <tr>
            <td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage/getItem">getItem(keyName)</a></td>
            <td>Retrieves the <code>keyValue</code> in localStorage associated with <code>keyName</code></td>
          </tr>
          <tr>
            <td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage/removeItem">removeItem(keyName)</a></td>
            <td>Removes the <code>keyName</code> location in localStorage</td>
          </tr>
        </table>

      </section>


      <section>
        <h2><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage">localStorage</a> example</h2>
        <pre><code data-trim>window.localStorage.setItem("Melissa", "Mowgli");
window.localStorage.setItem("Lauren", "Spot");
window.localStorage.setItem("Jacki", "Moss");
let bestPet = window.localStorage.getItem("Lauren");
window.localStorage.removeItem("Jacki");</code></pre>
        <p class="code-caption">JavaScript (example)</p>
        <div class="side-by-side">
          <div>
            <p>before closing the browser tab</p>
            <img src="img/localStorage.png" alt="localStorage before example">
          </div>
          <div>
            <p>after closing the browser tab</p>
            <img src="img/localStorage.png" alt="localStorage after example">
          </div>
        </div>
      </section>



      <section>
        <h2><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/sessionStorage">sessionStorage</a> example</h2>
        <p>Similarly for sessionStorage</p>
        <pre><code data-trim>window.sessionStorage.setItem("Melissa", "Mowgli");
window.sessionStorage.setItem("Lauren", "Spot");
window.sessionStorage.setItem("Jacki", "Moss");
let bestPet = window.sessionStorage.getItem("Lauren");
window.sessionStorage.removeItem("Jacki");</code></pre>
        <p class="code-caption">JavaScript (example)</p>
        <div class="side-by-side">
          <div>
            <p>before closing the browser tab</p>
            <img src="img/sessionStorage.png" alt="sessionStorage before example">
          </div>
          <div>
            <p>after closing the browser tab</p>
            <img src="img/sessionStorageAfter.png" alt="sessionStorage after example">
          </div>
        </div>
      </section>


      <section>
        <h2><code>indexDB</code></h2>
      </section>

      <section>
        <section>
          <h2><a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API"><code>indexDB</code></a></h2>
          <p><code>cookies</code>, <code>localStorage</code>,
            <code>sessionStorage</code> can only store small amounts of
            data
          </p>
          <p>
            <code>indexDB</code> is a "a low-level API for client-side storage
            of significant amounts of structured data, including files/blobs"
          </p>
          <p>
            Look down through the slides if you want to know more...
          </p>
        </section>

        <section>
          <h2><code>indexDB</code> usage</h2>
          <p>There are many flavors types of indexDB - so apparently you have to cover your
            bases with creating the database for your page:
          </p>
          <pre><code data-trim>// This works on all devices/browsers, and uses
// IndexedDBShim as a final fallback
let indexedDB = window.indexedDB || window.mozIndexedDB ||
                window.webkitIndexedDB || window.msIndexedDB ||
                window.shimIndexedDB;
// Open (or create) the database
let openDB = indexedDB.open(&lt;dbname&gt;, &lt;version&gt;);</code></pre>
          <p class="code-caption">JavaScript (template)</p>
          <pre><code data-trim>// This works on all devices/browsers,
// and uses IndexedDBShim as a final fallback
let indexedDB = window.indexedDB || window.mozIndexedDB ||
                window.webkitIndexedDB || window.msIndexedDB ||
                window.shimIndexedDB;
// Open (or create) the database
let openDB = indexedDB.open("terms", 1);</code></pre>
          <p class="code-caption">JavaScript (example)</p>
        </section>


        <section>
          <h2><code>indexDB</code> usage</h2>
          <p>You need to set callbacks on the new database object, so once
            the database is created, the tables (schema) can be created.
          </p>
          <pre><code data-trim>openDB.onupgradeneeded = function() {
  let db = openDB.result;
  let store = db.createObjectStore("terms", {keyPath: "term"});
  let index = store.createIndex("definition", "definition", { unique: false });
};
openDB.onsuccess = function() {
  console.log("Database created!");
}</code></pre>
        <p class="code-caption">JavaScript (example)</p>
        </section>


        <section>
          <h2><code>indexDB</code> setting values</h2>
          <pre><code data-trim>// Start a new transaction
let db = openDB.result;
let tx = db.transaction("terms", "readwrite");
let store = tx.objectStore("terms");
let index = store.index("definition");

// get the term and definition from the user

store.put({key: userTerm, definition: userDef});

// Close the db when the transaction is done
tx.oncomplete = function() {
  db.close();
};</code></pre>
          <p class="code-caption">JavaScript (example)</p>
        </section>

        <section>
          <h2><code>indexDB</code> getting values</h2>
          <pre><code data-trim>// assume the variable term has been set
let getValue = store.get(term);

getValue.onsuccess = function() {
  alert(getValue.result.definition);
};

getValue.onerror = function() {
  // error handling here
};</code></pre>
          <p class="code-caption">JavaScript (example)</p>
        </section>
      </section>


      <section>
        <h2>Phew... that was a lot of work. And confusing too </h2>
        <p>Dexie to the rescue</p>
      </section>


      <section>
        <h2><a href="http://dexie.org/">Dexie</a></h2>
        <p>Dexie is a wrapper around <code>indexDB</code> that makes it MUCH easier to use. </p>
        <pre><code class="small-font" data-trim>// create the database (module global)
let db = new Dexie(&lt;name of database&gt;);
window.addEventListener("load", init);
function init () {
  // set up the schema
  db.version(1).stores({
    // this is the table with the columns that are to be indexed.
    &lt;tableName&gt;: '&lt;column1&gt;, &lt;column2&gt;...'
  });
};</code></pre>
        <p class="code-caption">JavaScript (template)</p>
        <pre><code class="small-font" data-trim>let db = new Dexie("definitions");
window.addEventListener("load", init);
function init () {
  // set up the schema
  db.version(1).stores({
    terms: 'term,definition'
  });
};</code></pre>
        <p class="code-caption">JavaScript (example)</p>
      </section>

      <section>
        <h2>Dexie <a href="http://dexie.org/docs/Table/Table.put()">put</a></h2>
        <p>Putting an item in a table is pretty straight forward: </p>
        <pre><code data-trim>db.&lt;tableName&gt;.put({"column1": &lt;value1&gt;, "column2": &lt;value2&gt;, ...});</code></pre>
        <p class="code-caption">JavaScript (template)</p>
        <pre><code data-trim>db.terms.put({"term": term, "definition": definition});</code></pre>
        <p class="code-caption">JavaScript (example)</p>
      </section>


      <section>
        <h2>Dexie <a href="http://dexie.org/docs/Table/Table.get()">get</a></h2>
        <p>There are two ways to get information back out of a table, using either a
        callback, or a <code>Promise</code> </p>
        <pre><code data-trim>// get with a callback
db.&lt;tableName&gt;.get(&lt;key&gt;, function (item) {
  // do something here
});
// get with a Promise.
db.&lt;tableName&gt;.get(&lt;key&gt;).then (function (item) {
  // do something here
}); </code></pre>
        <p class="code-caption">JavaScript (template)</p>
        <pre><code data-trim>db.terms.get(term, function (item) {
  console.log("Callback: Item at " + term + " is " + item.definition);
});

db.terms.get(term).then (function (item) {
  console.log("Promise: Item at " + term + " is " + item.definition);
});</code></pre>
        <p class="code-caption">JavaScript (example)</p>
      </section>

      <section>
        <h2>Compliance</h2>
        <p>
          The one issue with all of these newer technologies
          (<code>localStorage</code>, <code>sessionStorage</code>,
          <code>indexDB</code>, and frameworks like <code>Dexie</code>) is cross
          browser compatibilty
        </p>
        <p>
          <a href="https://whatwebcando.today/">What Web Can Do Today</a>
          (Try this in different browsers or on your phone)
        </p>
        <p>
          <a href="https://www.w3.org/2018/04/web-roadmaps/mobile/">Roadmap of Web Applications on Mobile</a>
        </p>
        <p>
          <a href="https://caniuse.com/">Can I use</a> - "provides  up-to-date browser support tables for
            support of front-end web technologies on desktop and mobile web browsers."
        </p>
      </section>

        <section>
          <h2>Post lecture quick check</h2>
        </section>
      <section>
        <iframe src="https://embed.polleverywhere.com/multiple_choice_polls/zZfOgnl2caG4CJvZ0H5kU?controls=none&short_poll=true" width="800px" height="400px"  frameBorder="0"></iframe>
      </section>

      <section>
        <iframe src="https://embed.polleverywhere.com/multiple_choice_polls/xgcnByfvFsNndc2YsaRVA?controls=none&short_poll=true" width="800px" height="400px"  frameBorder="0"></iframe>
      </section>

      <section>
        <iframe src="https://embed.polleverywhere.com/multiple_choice_polls/XB8ZckXNfHaF17N88o0N8?controls=none&short_poll=true"  width="800px" height="400px" frameBorder="0"></iframe>
      </section>

      <section>
        <iframe src="https://embed.polleverywhere.com/multiple_choice_polls/6il27nq5b7hQqQPs5x137?controls=none&short_poll=true"  width="800px" height="400px"frameBorder="0"></iframe>
      </section>




      </div>
    </div>

   <script src="../../site/reveal/lib/js/head.min.js"></script>
      <script src="../../site/reveal/js/reveal.js"></script>

      <script>

        Reveal.initialize({
          controls: true,
          progress: true,
          history: true,
          center: true,

          transition: 'slide', // none/fade/slide/convex/concave/zoom

          // More info https://github.com/hakimel/reveal.js#dependencies
          dependencies: [
            { src: '../../site/reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
            { src: '../../site/reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: '../../site/reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
            { src: '../../site/reveal/plugin/highlight/highlight.pack.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
            { src: '../../site/reveal/plugin/zoom-js/zoom.js', async: true },
            { src: '../../site/reveal/plugin/notes/notes.js', async: true },
            { src: '../../site/reveal/plugin/search/search.js', async: true },
            { src: '../../site/reveal/plugin/print-pdf/printpdfbtn.js', async: true }
          ]
        });

      </script>

    </body>
  </html>
