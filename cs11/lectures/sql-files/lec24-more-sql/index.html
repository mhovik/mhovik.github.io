<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Lecture 24 - More SQL</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="../../site/reveal/css/reveal.css">
    <link rel="stylesheet" href="../../site/reveal/css/theme/white.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../site/reveal/lib/css/color-brewer.css">
    <link rel="stylesheet" href="../../site/reveal/css/154-override.css">

    <!-- Printing and PDF exports -->
    <script>
var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? '../../site/reveal/css/print/pdf.css' :
'../../site/reveal/css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
      <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
    <style>
      .hidden {
          display: none;
      }

    </style>
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

        <section>
          <h1>Lecture 24 - More SQL</h1>
        </section>

        <section>
          <h2>Announcements</h2>
          <p>Exploration session Thursday May 30th, 4:30 pm on computer networks</p>
          <p>Announcing HW 5 - Pokedex 2</p>
          <p class="space-left">
            In a few days we will be pushing more to the starter repository.
            You will get an email... do a
            a <code>git pull origin master</code> when you do to get the latest stuff!
          </p>
          <p>
          CP4 Showcase is <a href="https://courses.cs.washington.edu/courses/cse154/19sp/creative/cp-showcase.html">out</a>!
          </p>
          <p class="space-left">
            Note: You will need log in with your uwid for a few projects that create content (for content moderation).
          </p>
        </section>

        <section>
          <p>Today's Agenda</p>
          <ul>
            <li>More PHP/PDO/MySQL connections (with) INSERT</li>
            <li>More database manipulation
              <ul>
                <li><a href="#delete">DELETE data from a table</a></li>
                <li><a href="#update">UPDATE data in a table</a></li>
              </ul>
            </li>
          </ul>
        </section>

        <section>
          <section>
            <h2>Review</h2>
            <p>Take a moment to review the 4 slides below</p>
            <ul>
              <li>
                Connecting to the database <a href="#connecting-db-general">in general</a> and
                 <a href="#connecting-db-example">an example (WPL)</a>
              </li>
              <li>
                <code>try/catch</code> <a href="#try-catch-general">in general</a> and
                 <a href="#try-catch-example">an example</a>
              </li>
            </ul>
          </section>

          <section id="connecting-db-general">
            <h2>Connecting to a database</h2>
            <p>
              To connect to a database you need 4-5 pieces of information:
            </p>
              <ul>
                <li>host</li>
                <li>port (maybe)</li>
                <li>database name</li>
                <li>the user name for the database</li>
                <li>the database password</li>
              </ul>
              <p>
                Then create a <code><a href="http://php.net/manual/en/class.pdo.php">PDO</a></code>
                object</code> to represent the database connection
              </p>
            </section>

            <section id="connecting-db-example">
              <h2>PDO Connection</h2>
              <p>
                To find find out what to use with phpMyAdmin, check out the MAMP WebStart page.
                For other systems you have to do searching on the web.
              </p>
              <div class="side-by-side">
                <div class="one-third-width">
                  <img class="simpleimg" src="images/mamp-start-page.png" alt="mamp start page mysql settings">
                </div>
                <div class="two-thirds-width">
                  <pre><code data-trim>
# Variables for connections to the database.
$host =  'localhost'; #fill in with server name
$port =  '8889';      #fill in with a port if necessary (will be different mac/pc)
$dbname = 'wpldb';    #fill in with db name
$user = 'root';       #fill in with user name
$password = 'root';   #fill in with password (will be different mac/pc)

# Make a data source string to create the PDO
$ds = "mysql:host={$host}:{$port};dbname={$dbname};charset=utf8";

# connect to the wpldb and set some attributes
$db = new PDO($ds, $user, $password);
$db->setAttribute(PDO::ATTR_ERRMODE,
                 PDO::ERRMODE_EXCEPTION);
                </pre></code>
                <p class="code-caption">PHP (example)</p>
              </div>
            </section>

            <section id="try-catch-general">
              <h2><code>try</code>/<code>catch</code></h2>
              <p>Database connections can have different problems: the database server
                could be down, the database could be missing or corrupted
              </p>
              <p>
                <code>try</code>/<code>catch</code> helps us catch and
                 identify when errors occur so we can handle the error correctly
               </p>
               <pre><code data-trim>
try {
  # things to try that could throw an error
}
catch (PDOException $pdoex) {
  # code for handling the error here.
}
            </pre></code>
           <p class="code-caption">PHP (template)</p>
         </section>

       <section id="try-catch-example">
        <h2><code>try</code>/<code>catch</code> example</h2>
        <pre><code data-trim>
try {
 $db = new PDO($ds, $user, $password);
 $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
}
catch (PDOException $pdoex) {
 header("HTTP/1.1 503 Invalid Request");
 header("Content-Type: text/plain");
 die("Can not connect to the database. Please try again later.");
}
             </pre></code>
             <p class="code-caption">PHP (example)</p>
           </section>
         </section>

         <section>
           <h2>Quickcheck 1</h2>
           <p>Get in pairs</p>
           <p>
             Partner 1: explain to partner 2 what SQL or MySQL is and how it relates to a
             full stack applications.
           </p>
           <p>
             Partner 2: explain to partner 1 what PHP is and how it is used in a
             full stack application.
           </p>
           <p>
             Together: Come up with a description of what the PDO object is and represents,
             why we use it, and what are some of the things we can do with it?
           </p>
         </section>

         <section>
           <h2><a href="quickcheck.php">Quick check</a> 2</h2>
           <div class="side-by-side">
             <div>
               <pre class="font-14pt"><code data-trim>
print("1");

$host     = 'localhost';
$port     = '8889';
$user     = 'root';
$password = 'root';
$dbname   = 'wpldb';
$ds = "mysql:host={$host}:{$port};" +
      "dbname={$dbname};charset=utf8";

print("2");

try {
  $db = new PDO($ds, $user, $password);
  $db->setAttribute(PDO::ATTR_ERRMODE,
               PDO::ERRMODE_EXCEPTION);
  print("3");
}
catch (PDOException $ex) {
  die("4");
}

print("5");
            </pre></code>
            <p class="code-caption">PHP</p>
          </div>
          <div>
            <p>What displays if this script is run and there are no database errors? </p>
            <p class="fragment">1235</p>
            <p class="fragment">What displays if this script is run and there is a database error? </p>
            <p class="fragment">124</p>
          </div>
        </div>
       </section>

       <section>
         <h2>What else... </h2>
         <p>
           What does a PDO Object encapsulate? <span class="fragment">a connection to the database</span>
         </p>
         <p class="fragment">
           For a valid PDO object <code>$db</code>, what is returned by <br>
           <code>$db->query("SQL query string");</code>?
           <span class="fragment">a PDOStatement object</span>
         </p>
         <p class="fragment">
          How do you view the rows encapsulated in a PDOStatement?
          <span class="fragment">Use... </span>
        </p>
        <ul>
          <li class="fragment"><code>fetch</code></li>
          <li class="fragment"><code>fetchAll</code></li>
          <li class="fragment"><code>foreach</code> or other type of loop</li>
        </ul>
        <p class="fragment">
          What do the arrays from PDOStatement::fetch contain?
          <span class="fragment">Associations between the column names and data and/or
            the column positions and the data, by default it's both (PDO::FETCH_BOTH)</span></p>
        </p>
        <p class="fragment">
          What flags can you use to adjust these associations?
          <span class="fragment">PDO::FETCH_ASSOC or PDO::FETCH_NUM</span></p>

        </p>
        </section>

       <section>
         <h2>PDO and modifying DBs</h2>
         <p>Remember...
           <span class="fragment"><a href="https://youtu.be/b23wrRfy7SM?t=6">With
             Great Power Comes Great Responsibility</a></span>
         </p>
       </section>

        <section>
          <h2>Inserting through PHP</h2>
          <p>
            Use the <code>PDO::</code>
            <a href="http://php.net/manual/en/function.exec.php"><code>exec</code></a>
            function to run a given SQL statement and return the number of rows affected, not
            the actual set of results.
          </p>
           <pre><code data-trim>
$str = "INSERT INTO wpl (name, email, student_id, time, question) " .
          "VALUES ('$name', '$email', '$student_id', '$time', '$question');";
$rows = $db->exec($str);
           </pre></code>
           <p class="code-caption">PHP (example)</p>
           <pre><code data-trim>1</pre></code>
           <p class="code-caption">PHP (results)</p>
           <p class="fragment">However <code>exec</code> is not secure!!!
           It is vulnerable to
            <a href="https://developer.mozilla.org/en-US/docs/Glossary/SQL_Injection">SQL injection</a>
            (demo)</p>
          </section>

          <section>
            <h2>Little Bobby Tables</h2>
            <p><img class="simpleimg" style="width: 900px" src="https://imgs.xkcd.com/comics/exploits_of_a_mom.png" /></p>
            <p><a href="https://xkcd.com/327/">XKCD 327</a></p>
          </section>

          <section>
            <h2>Another example of SQL injection</h2>
            <p><img class="simpleimg" src="https://hackaday.com/wp-content/uploads/2014/04/18mpenleoksq8jpg.jpg?w=636" /></p>
            <p><a href="https://hackaday.com/2014/04/04/sql-injection-fools-speed-traps-and-clears-your-record/">Hackaday</a></p>
          </section>

        <section>
            <h2>Using PDO
              <a ref="http://php.net/manual/en/pdo.prepare.php"><code>prepare</code></a>/<a href="http://php.net/manual/en/pdostatement.execute.php">
                <code>execute</code></a> for security</h2>
            <pre class="font-14pt"><code data-trim>
$sql = "INSERT INTO queue(name, email, student_id, time, question) " .
        "VALUES (:name, :email, :student_id, :time, :question);";
$stmt = $db->prepare($sql);

# create the associative array between the variables in the
# insert SQL statement with the actual values
$params = array("name" => $name,
               "email" => $email,
               "student_id" => $sid,
               "time" => $minutes,
               "question" => $question);
$stmt->execute($params);  # notice no return value!
         </pre></code>
         <p class="code-caption">PHP (example)</p>
         <p>
           The "variables" with colons in the <code>prepare</code>'d SQL statement are replaced with
           values from the associative array that is being passed in to <code>execute</code>
         </p>
         <p><strong>Note:</strong> INSERT does not return a set of rows as a result. However, if you
           did a query that *does* return a set of rows, you still have to get them from the
           <code>$stmt</code> PDOStatement using <code>fetch</code> as before.
         </p>
        </section>

        <section>
          <h2><code>prepare</code>/<code>execute</code></h2>
          <p>Use <code>prepare</code>/<code>execute</code> whenever there is a "variable"
            that is used in a SQL statement will be executed
          </p>
          <pre><code data-trim>
          # This is ok because it does not have any variables it is using in the query
          $rows = $db->query("SELECT * FROM queue;");

          # This is insecure because it is using a variable that can potentially do
          # SQL injection
          $rows = $db->query("SELECT * FROM queue WHERE time = {$time};");

          # Instead do this:
          $sql = "SELECT * FROM queue WHERE time = :time;";
          $stmt = $db->prepare($sql);
          $params = array("time" => $minutes);
          $stmt->execute($params);
          </code></pre>
          <p class="code-caption">PHP</p>

        </section>

        <section>
          <h2>More SQL Commands</h2>
        </section>


        <section id="delete">
          <h2><a href="https://www.w3schools.com/sql/sql_update.asp">
            <code>DELETE</code></a></h2>
            <p> Deletes the specified records based on the results of the WHERE clause</p>
            <p> CAUTION: if you omit the WHERE clause all records will be deleted!!!</p>
          <pre><code data-trim>
  DELETE FROM table WHERE condition;
          </code></pre>
          <p class="code-caption">SQL (template)</p>
          <pre><code data-trim>
          DELETE FROM queue WHERE id = 8;
          DELETE FROM queue WHERE name = "Lauren Bricker";
          DELETE FROM queue;   # caution!!!
          </code></pre>
          <p class="code-caption">SQL (example)</p>

        </section>

        <section>
            <h2>What if I wanted to delete someone in our WPL queue?</h2>
            <p>It might help to have <a href="../lec24/wpl-queue2.zip">this code</a> on your laptop</p>
            <ul>
              <li class="fragment">
                What would you want to do to your interface to allow users to easily delete
                an entry?
              </li>
              <li class="fragment">
                What query statement would you need to delete something from the database?
              </li>
              <li class="fragment">
                What code do you have to modify? What code do you have to create?
              </li>
              <li class="fragment">
                What code could you look at/model after to create your first version of new code?
              </li>
              <li class="fragment">
                How can you test your SQL statements?
              </li>
              <li class="fragment">
                How can you test your PHP code?
              </li>
              <li class="fragment">
                How can you test your JS code/Website?
              </li>
            </ul>
            <p class="fragment">Demo!</p>
        </section>

        <section id="update">
          <h2><a href="https://www.w3schools.com/sql/sql_update.asp">
            <code>UPDATE</code></a></h2>
          <pre><code data-trim>UPDATE table
SET col1 = val1, col2 = val2, ...
WHERE condition;
          </code></pre>
          <p class="code-caption">SQL (template)</p>
          <pre><code data-trim>
          UPDATE queue
          SET question = "This is a different, harder question"
          WHERE id = 4;
          </code></pre>
          <p class="code-caption">SQL (example)</p>

        <p> UPDATE changes all rows where the condition is true.
        </section>

        <section>
          <h2>Debugging Strategies</h2>
          <ul>
            <li>
              Make sure your have the following set in your code

              <pre><code data-trim>display_errors = on is set in php.ini</code></pre>
            </li>
            <li>
              Looking in the <code>mysql_error_log.err</code> and <code>php_error.log</code>log
              files (C:/MAMP/logs/ on PC or /Application/MAMP/logs on Mac)
            </li>
            <li>Create your own tester program to do GET or POST requests.</li>
            <li>Postman (you need both)</li>
            <ul>
              <li><a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop?hl=en">Chrome App</a></li>
              <li><a href="https://chrome.google.com/webstore/detail/postman-interceptor/aicmkgpgakddgnaphhhpliifpcfhicfo?hl=en">Chrome Extension (Interceptor)</a></li>
            </ul>
        </ul>
        </section>



      </div>
    </div>

    <script src="../../site/reveal/lib/js/head.min.js"></script>
    <script src="../../site/reveal/js/reveal.js"></script>

    <script>

Reveal.initialize({
  controls: true,
  progress: true,
  history: true,
  center: true,

  transition: 'slide', // none/fade/slide/convex/concave/zoom

  // More info https://github.com/hakimel/reveal.js#dependencies
  dependencies: [
  { src: '../../site/reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
  { src: '../../site/reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
  { src: '../../site/reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
  { src: '../../site/reveal/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
  { src: '../../site/reveal/plugin/zoom-js/zoom.js', async: true },
  { src: '../../site/reveal/plugin/notes/notes.js', async: true },
  { src: '../../site/reveal/plugin/search/search.js', async: true },
  { src: '../../site/reveal/plugin/print-pdf/printpdfbtn.js', async: true }
  ]
});

    </script>
  </body>
</html>
