<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Lecture 22 - Node.js with SQL</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="../../site/reveal/css/reveal.css">
    <link rel="stylesheet" href="../../site/reveal/css/theme/white.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../site/reveal/lib/css/color-brewer.css">
    <link rel="stylesheet" href="../../site/reveal/css/154-override.css">

    <!-- Printing and PDF exports -->
    <script>
var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? '../../site/reveal/css/print/pdf.css' :
'../../site/reveal/css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
      <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

        <section>
          <h2>Lecture 22 - Node.js and SQL Connection</h2>
        </section>
        <section>
          <h2>Final Project Milestone</h2>
          <p>Due tonight at 11PM (no late days)</p>
          <p>The repo doesn't include the <code>.gitignore</code> you had in CP4/HW4</p>
          <p>Make sure you don't push <code>node_modules</code>. You can copy the <code>.gitignore</code> from HW4/CP4 into your Final Project repo and add/commit/push it to ignore your <code>node_modules</code> (before pushing everything else)</p>
        </section>

        <section>
          <h2>A Few Common Questions</h2>
          <p>Why doesn't this work?</p>
          <pre><code>/**
 * Sends a hello message given a required name query parameter.
 * Example: /hello?name=dubs returns "Hello dubs!"
 * Sends a 400 error if missing the required name parameter.
 * All responses are plain text.
 */
app.get("/hello", (req, res) => {
  if (!req.query.name) {
    res.status(400).send("Missing required name parameter.");
  }
  console.log("This is logged after missing parameter check.");
  res.send("Hello " + req.query.name + "!");
});</code></pre>
<p class="code-caption">JS</p>
<p><a href="code/ending-request-demo.js" target="_blank">ending-request-demo.js</a></p>
</section>
        <section>
          <h2>Running Demo Output</h2>
          <img class="centered-figure w-80" src="hidden/ending-request-demo.png" alt="Demo of sending headers twice" />
        </section>
        <section>
          <h2>What Happened?</h2>
          <p>From the documentation of <code>res.end</code> (internally called by in <code>res.send</code>):</p>
          <p class="italic">"This method signals to the server that all of the response headers and body have been sent; that server should consider this message complete."</p>
          <p>They <strong>do not have any control over the termination of your JS program</strong>.</p>
          <p>You can continue to do other things, such as reading/writing files, logging, etc.</p>
          <p>However, you <strong>do not</strong> have the ability to modify the Response object (<code>res</code>).</p>
          <p>You can solve the above problem using if/else logic - when trying to factor out errors, you can use middleware functions (see documented example from Monday's "Extra Resources").</p>
        </section>
        <section>
          <h2>A Fixed Version</h2>
          <pre><code>/**
 * Sends a hello message given a required name query parameter.
 * Example: /hello?name=dubs returns "Hello dubs!"
 * Sends a 400 error if missing the required name parameter.
 * All responses are sent as plain text.
 */
app.get("/hello", (req, res) => {
  if (!req.query.name) {
    res.status(400).send("Missing required name parameter.");
  } else {
    console.log("This is logged after missing parameter check.");
    res.send("Hello " + req.query.name + "!");
  }
});</code></pre>
<p class="code-caption">JS</p>
          <p>Note: This can be subtle, but is common and will always be logged to your terminal line, often related to the <a href="https://nodejs.org/api/errors.html#errors_err_http_headers_sent" target="_blank"><code>ERR_HTTP_HEADERS_SENT</code></a> error ("Cannot set headers after they are sent to the client").</p>
        </section>

        <section>
          <h2>Today's Agenda</h2>
          <p>More SQL commands and database manipulation, including:</p>
          <ul>
            <li>CREATE TABLE</li>
            <li>INSERT into a table</li>
          </ul>
          <p>The Node.js/SQL Connection with the <code>promise-mysql</code> module</p>
        </section>

        <section>
          <h2>Check Your Understanding</h2>
          <p>What is the preferred technology for storing and manipulating large amounts of data on the server and why?</p>
          <ol>
            <li>Text files on the server which can be easily modified while still keeping it organized.</li>
            <li>JSON, because it is easy to read and parses quickly.</li>
            <li>Punchcards, because servers can be hacked too easily.</li>
            <li>Relational databases because they can quickly search, filter, update, and send large amounts of data.</li>
          </ol>
        </section>

        <section>
          <h2>Creating your own SQL Tables</h2>
          <ol>
            <li>You can create a new database in <code>phpMyAdmin</code> (e.g. pokedexdb)</li>
            <li>Then you can add tables either by importing a .sql file (preferred), a .csv file (practiced in section yesterday) or copy/pasting the SQL code using the SQL query tab in phpMyAdmin</li>
            <li>But how do we create tables?</li>
          </ol>
        </section>

        <section id="create">
          <h2><code>CREATE TABLE</code>: Syntax</h2>
          <p><a href="https://www.w3schools.com/sql/sql_create_table.asp">CREATE TABLE</a> is used to create a new table.</p>
          <p>Syntax:</p>
          <pre><code data-trim class="syntax-no-highlight">CREATE TABLE table_name(
  column1 datatype PRIMARY KEY,
  column2 datatype,
  column3 datatype,
  .....
  columnN datatype
);</pre></code>
        <p class="code-caption">SQL (template)</p>
        </section>

        <section>
           <h2>SQL Data Types</h2>
           <p>Each column must have a defined data type</p>
           <p>The following are the most common:</p>
           <table>
             <tr>
               <th>Type</th>
               <th>Argument</th>
               <th>Description</th>
             </tr>
             <tr>
               <td>INT</td>
               <td>none</td>
               <td>An integer number</td>
             </tr>
             <tr>
               <td>VARCHAR(<em>n</em>)</td>
               <td>The string can be at most <em>n</em> characters (max of 65,535).</td>
               <td>a text string</td>
             </tr>
             <tr>
               <td>DATE</td>
               <td>none</td>
               <td>Stores dates: YYYY-MM-DD</td>
             </tr>
             <tr>
               <td>DATETIME</td>
               <td>none</td>
               <td>Stores dates and times for precise time information: YYYY-MM-DD HH:MM:SS</td>
             </tr>
             <tr>
               <td>DECIMAL(<em>d</em>,<em>s</em>)</td>
               <td>Has at most <em>d</em> digits, and <em>s</em> digits after the decimal place</td>
               <td>A decimal number. Rounds based on the provided precision.</td>
             </tr>
             <tr>
               <td>TEXT</td>
               <td>none</td>
               <td>A potentially very large text string.</td>
             </tr>
           </table>
           <p>
             Prefer VARCHAR to TEXT, and with as small a max limit as you are comfortable
             setting. This limits the amount of data someone can dump into your table.
           </p>
        </section>

        <section>
          <h2>Useful Column Constraints</h2>
          <p>The following are very common and useful in CREATE TABLE statements.</p>
          <p>These are called constraints - they "constrain" the types of values you can insert in a column.</p>
          <p>Today's <a href="https://www.tutorialrepublic.com/sql-tutorial/sql-constraints.php" target="_blank">reading on constraints</a> is an excellent overview for more details.</p>
          <ul>
            <li>PRIMARY KEY (keyname):
              Used to specify a column or group of columns uniquely identifies a row in a table.
            </li>
            <li>AUTO_INCREMENT</td>:
              Used with a primary key field to automatically generate the "next" value in a particular
              column when a new row is added. Only available in numerical fields.
            </li>
            <li>NOT NULL:
              prevents NULL entries in a column, requires the value to be set in INSERT statements.
            </li>
            <li>DEFAULT: specifies default values for a column if not provided in an INSERT statement</p>
            <li>UNIQUE: requires an attribute to be unique (useful for fields that are not PRIMARY KEY but should still be unique)</p>
          </ul>
        </section>
          <section>
            <h3>PRIMARY KEY and AUTO_INCREMENT</h3>
            <p>
              Every table should have a column which is used to uniquely identify each row. This
              improves efficiency and will prove very useful when using multiple tables.
            </p>
            <pre><code>CREATE TABLE students(
  id                       INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255)        NOT NULL,
  username VARCHAR(255)    NOT NULL UNIQUE
  email VARCHAR(255)       NOT NULL
);</code></pre>
            <p class="code-caption">Basic SQL Example</p>
            <p>
              Adding <code>PRIMARY KEY</code> makes it so that the code will error if that
              column ever has duplicates. It will use that column to identify each row quickly.
              This is usually an integer id, but can also be other types. Conventionally named <code>id</code> or prefixed with a letter (e.g. <code>sid</code> for "student id")</p>
            </p>
            <p>
              <code>AUTO_INCREMENT</code> will make it so that, if you provide no input for that
              column, it will pick the next unused value. Perfect for making it so you don't have to
              worry about what the next id is.
            </p>
          </section>

        <section>
          <h2>Remember the WPL Queue?</h2>
          <p>
            We introduced the WPL queue to teach Forms and validation on the client-side.
            What types of data might we want to store in a database (<code>wpldb</code>) for the WPL Queue?
          </p>
          <div class="side-by-side">
            <div>
              <img src="hidden/wpl-queue.png" alt="WPL queue">
            </div>
            <div>
              <p class="fragment">Text-based</p>
              <ul>
                <li class="fragment">The name of the student</li>
                <li class="fragment">The email address</li>
                <li class="fragment">The question text</li>
              </ul>
              <p class="fragment">But what about...</p>
              <ul>
                <li class="fragment">The student number (this could also be text)</li>
                <li class="fragment">The question length (2 or 10)</li>
                <li class="fragment">A unique identifier for each question</li>
                <li class="fragment">When the question was submitted</li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h2><code>CREATE TABLE</code> example</h2>
          <p>What would the <code>CREATE TABLE </code> SQL command look like to create
            a table to hold the <em>queue</em> for the WPL example?</p>
          <div class="fragment">
            <pre><code data-trim>CREATE TABLE queue(
   id             INT PRIMARY KEY AUTO_INCREMENT,
   name           VARCHAR(255),
   email          VARCHAR(255),
   student_id     INT,
   length         TINYINT,      -- e.g. 2 or 10
   question       VARCHAR(255), -- max of 255 characters per question
   creation_time  DATETIME DEFAULT NOW()
);</pre></code>
          <p class="code-caption">SQL (example)</p>
        </div>
      </section>

        <section>
          <h2>The .sql File</h2>
          <p>Can be imported to execute SQL commands, often to create new tables (conventionally starting with <code>setup</code> in the file name)</p>
          <pre><code data-trim>-- Author: Melissa Hovik
-- Last updated: 08.13.19
-- Creates a queue table of questions for the WPL database, wpldb.
CREATE TABLE queue(
   id             INT PRIMARY KEY AUTO_INCREMENT,
   name           VARCHAR(255),
   email          VARCHAR(255),
   student_id     INT,
   length         TINYINT,
   question       VARCHAR(255),
   creation_time  DATETIME DEFAULT NOW()
);</pre></code>
          <p class="code-caption"><a href="data/setup-wpl.sql" target="_blank">setup-wpl.sql</a></p>
          <p>
            Note: Use <code>--</code> for comments in SQL (for each line).
          </p>
          <p>To import a .sql file like this in phpMyAdmin, you must use the Import tab with an existing database selected (e.g. <code>wpldb</code>).</p>
        </section>

        <section>
          <h2>Another <code>CREATE TABLE</code> example</h2>
          <p>This is an example using a few different DEFAULT constraints to represent a table for blog posts.</p>
          <p>For DATETIME columns, it is convenient to use NOW() as the DEFAULT so that you don't have to calculate the date/time manually</p>
          <div class="fragment">
            <pre><code data-trim>-- Author: Melissa Hovik
-- Last updated: 08.13.19
-- Sets up a new blog_posts table in a blog database.
CREATE TABLE blog_posts(
  id              INT PRIMARY KEY AUTO_INCREMENT,
  title           VARCHAR(255) DEFAULT "Untitled Post",
  author          VARCHAR(100) DEFAULT "anonymous",
  category        VARCHAR(100) DEFAULT "other",
  creation_time   DATETIME DEFAULT NOW()
);</pre></code>
          <p class="code-caption"><a href="data/setup-blog.sql" target="_blank">setup-blog.sql</a></p>
        </div>
      </section>

      <section>
        <h2>Other table commands</h2>
        <p><code>DROP TABLE table_name;</code> deletes a table</p>
        <p><code>DROP TABLE IF EXISTS table_name;</code> deletes a table only
          if it exists, which prevents an error if it doesn't</p>
        <p><code>CREATE TABLE IF NOT EXISTS blog_posts( ... )</code></p>
        <ul>
          <li>The <code>IF NOT EXISTS</code> option is useful if you want the table to be created only if it is not already in a database when importing/executing table creation.</li>
        </ul>
      </section>

        <section>
          <h2>INSERT</h2>
          <p>To insert a new record into a table, we use the <code>INSERT INTO</code> keyword:</p>
          <pre><code class="font-12pt">CREATE TABLE cafemenu(
  id           INT  PRIMARY KEY AUTO_INCREMENT,
  name         VARCHAR(100) NOT NULL,
  category     VARCHAR(100) NOT NULL,
  description  VARCHAR(256) NOT NULL,
  image        VARCHAR(100) DEFAULT "food.png",
  qty          INT DEFAULT 0
);

INSERT INTO cafemenu (name, category, description)
VALUES ("Banana", "Fresh Fruit", "A fresh test banana.");</code></pre>
          <p class="code-caption">SQL</p>
          <p>
            First provide the table name, then optionally the list of columns you want to set
            (by default it sets all columns). Columns left out will be set to NULL, unless they
            have <code>AUTO_INCREMENT</code> set.
          </p>
          <p>Then provide the values for each column, which must match the column names specified.</p>
        </section>

      <section>
        <h2>The Node.js and SQL Connection</h2>
      </section>

        <section>
          <h2>From Monday: "A Preview to Node.js + SQL"</h2>
          <pre><code class="no-syntax-highlight">let qry = "SELECT name, id, type, weakness FROM pokedex " +
          "WHERE name LIKE '%r%' AND id &lt; 145 AND weakness = 'rock' " +
          "ORDER BY type, name DESC";
let rows = await db.query(filterQuery);
console.log(JSON.stringify(rows));
// [{"name":"Articuno","id":144,"type":"ice","weakness":"rock"}]</code></pre>
          <p class="code-caption">Node.js</p>
          <p>You can find the full solution <a href="code/filter-pokedex/filter-pokedex-sql.js" target="_blank">here</a> which uses a <code>pokedexdb</code>
          that can be populated in phpMyAdmin with this <a href="data/pokedex.csv" target="_blank"><code>pokedex.csv</code></a> file (refer to yesterday's section on .csv imports)</p>
        </section>

      <section>
        <h2>Full-stack website organization</h2>
        <div class="side-by-side">
          <div>
        <p>A full-stack website consists of three layers:</p>
        <ul class="font-16pt">
          <li>Web Browser (client): HTML, CSS, JS</li>
          <li>Web Server: Node.js</li>
          <li>Database Server: SQL</li>
        </ul>
      </div>
      <div>
        <img class="no-space-bottom" src="https://www.techaltum.com/img/full-stack-web-development.jpg" alt="client server image"/>
        <p class="citation"><a href="https://www.techaltum.com/img/full-stack-web-development.jpg" target="_blank">Image source</a></p>
      </div>
      </div>
          <p>The web server makes requests of the database server much like our client-side JS used AJAX</p>
          <p>The <code>promise-mysql</code> module will handle most of this for us.</p>
      </section>

    <section>
      <h2><code>mysql</code> vs. <code>promise-mysql</code></h2>
      <p><a href="https://github.com/mysqljs/mysql#introduction" target="_blank"><code>mysql</code></a> is the most popular module used to connect to a MySQL database in Node.js</p>
      <p class="fragment">Similar to the <code>fs</code> module functions, <code>mysql</code> functions are callback-last, with callbacks being error-first</code></p>
      <p class="fragment">We will use <a href="https://www.npmjs.com/package/promise-mysql" target="_blank"><code>promise-mysql</code></a> as an easier way to use <code>mysql</code> with async/await.</p>
      <ul>
        <li class="italic fragment">"promise-mysql is a wrapper for mysql that wraps function calls with Bluebird promises."</li>
      </ul>
      <p class="fragment">Similar to promisifying <code>fs</code> functions, these promise-returning functions will make it much easier to avoid callback pyramids.</p>
    </section>
    <section>
      <h2>A Comparison</h2>
      <pre><code class="font-12pt">db.query("SELECT * FROM some_table", (err, rows) => {
  if (err) {
    // handle error
  } else {
    db.query("SELECT * FROM other_table", (err2, rows2) => {
    if (err2) {
      // handle error
    } else {
      // ... do something with all the results
    }
  }
}</code></pre>
      <p class="code-caption">JS (using callback-based mysql module)</p>
      <pre><code class="font-14pt">try {
  let rows = await db.query("SELECT * FROM some_table");
  let rows2 = await db.query("SELECT * FROM other_table");
   // ... do something with all the results
} catch (err) {
  // handle generic connection error
}</code></pre>
      <p class="code-caption">JS (using promise-based promise-mysql-module)</p>
    </section>

    <section>
      <h2>The Basics of Using <code>promise-mysql</code></h2>
      <ol>
        <li>Connecton to your database with <code>mysql.createConnection</code> - this creates a new MySQL connection with given configuration options. We store this created object as a variable (conventionally called <code>db</code>).</li>
        <li>Use this connected object to execute SQL queries with <code>db.query(sqlString)</code></li>
        <li>When done with the database (including error-handling), you must <code>db.end()</code>, otherwise your program will hang.</li>
      </ol>
    </section>

        <section>
          <h2>Using SQL in Node.js</h2>
          <p>First install the <code>promise-mysql</code> module in your project.</p>
          <ul>
            <li><code>npm install promise-mysql</code></li>
          </ul>
          <p>Then require it with the rest of your modules in your Node.js program.</p>
          <ul>
            <li><code>const mysql = require("promise-mysql");</code></li>
          </ul>
      </section>
    <section>
      <h3>Connecting to a database with <code>mysql.createConnection</code></h3>
      <p>
        To connect to a database, you need the following information, which you can find on the MAMP start page:
      </p>
      <div class="side-by-side">
      <img class="simpleimg" src="hidden/mamp-start-page.png" alt="mamp start page mysql settings">

      <div>
        <ul class="font-16pt">
          <li><strong>host</strong> (defaults to localhost)</li>
          <li><strong>port</strong> (unlike the 8000 port in your Express app, you do not choose the port on MAMP - it is often set to 8889)</li>
          <li>the <strong>user name</strong> for the database (usually defaults to root)</li>
          <li>the database <strong>password</strong> (usually defaults to root)</li>
          <li><strong>database</strong> name</li>
        </ul>
      </div>
    </div>
        <p>
          We will use this configuration information to connect to MySQL and perform queries in Node.js.
        </p>
      </section>

      <section>
        <h2>SQL Connection</h2>
          <pre><code data-trim class="font-12pt">/**
 * Establishes a database connection to the pokedexdb and returns the database object.
 * Any errors that occur during connection should be caught in the function
 * that calls this one.
 * @returns {Object} - The database object for the connection.
 */
async function getDB() {
  let db = await mysql.createConnection({
    // Variables for connections to the database.
    host: "localhost",      // fill in with server name
    port: "8889",           // fill in with a port (will be different mac/pc)
    user: "root",           // fill in with username
    password: "root",       // fill in with password
    database: "pokedexdb"   // fill in with db name
  });
  return db;
}</pre></code>
          <p class="code-caption">JS (example)</p>
        </section>
        <section>
          <h3>Executing SQL queries with the <code>db</code> object</h3>
          <p>Once you have the <code>db</code> object, you can now execute SQL queries with <code>db.query</code></p>
          <p>This function takes a SQL query string and an optional array of options and returns a row of results.</p>
          <pre><code>let rows = db.query(sqlString, [options])</code></pre>
          <p class="code-caption">template</p>
          <pre><code>let rows = db.query("SELECT name, category FROM menu ORDER BY name;");</code></pre>
          <p class="code-caption">Node.js (example)</p>
        </section>
       <section>
         <h3>More about db.query(<em>sqlString</em>)</h3>
         <p>
           The query function returns an array of <code>RowDataPacket</code>s, which represent
           information for each row matching the query. In the below example, we limit at most 2 rows in the result.
         </p>
         <pre><code data-trim>let qry = "SELECT name, type FROM pokedex LIMIT 2;";
let rows = await db.query(qry);
console.log(rows);</pre></code>
       <p class="code-caption">Node.js (example)</p>
         <pre><code data-trim>[
  RowDataPacket { name: 'Bulbasaur', type: 'grass' },
  RowDataPacket { name: 'Ivysaur', type: 'grass' }
]</pre></code>
         <p class="code-caption">output</p>
       </section>

       <section>
         <h2>Extracting the data from the <code>RowDataPacket</code></h2>
         <p>The column (field) names for each row (record) can be accessed using dot notation (it's just an object!)</p>
         <pre><code data-trim>...
let qry = "SELECT name, type FROM pokedex LIMIT 2;";
let rows = await db.query(qry);
let firstRow = rows[0];
console.log("Name: " + firstRow.name + "(" + firstRow.type + ")");</pre></code>
       <p class="code-caption">Node.js (example)</p>
         <pre><code data-trim class="no-syntax-highlight">Name: Bulbasaur (grass)</code></pre>
         <p class="code-caption">output</p>
         <p>Note that only the column names specified in the SELECT statement will be accessible (for this example, <code>name</code> and <code>type</code>)</p>
       </section>

        <section>
          <h2>Closing the Connection</h2>
          <p>You must close the connection to the db, otherwise the program will hang.</p>
          <p>To do so, we can use <code>db.end()</code></p>
          <pre><code>let rows = db.query("...");
// do stuff with rows
db.end(); // close when you're done with the db object.</code></pre>
        <p>It's usually best to connect/close exactly once in the db - you can make multiple queries before closing.</p>
        </section>

        <section>
          <h2><code>try</code>/<code>catch</code></h2>
          <p>Database connections can have different problems: the database server
            could be down, the database could be missing or corrupted, the user/password credentials may be incorrect.
          </p>
          <p>
            You can find a good review of MySQL error codes <a href="https://github.com/mysqljs/mysql#error-handling" target="_blank">here</a> - useful when you are debugging and/or want to handle errors
            differently (similar to how we can use <code>err.code === "ENOENT"</code> in our response logic)</p>
          <p>
            <code>try</code>/<code>catch</code> helps us catch and
             identify when errors occur so we can handle the error correctly.
           </p>
         </section>
         <section>
           <h3>Using try/catch with <code>promise-mysql</code> functions</h3>
           <p>
             You can try/catch within <code>getDB()</code>, or you can try/catch in the function that calls <code>getDB()</code>,
             catching any errors that occur in the <code>mysql.createConnection</code> function.</p>
           <pre><code class="font-12pt no-syntax-highlight">try {
  let db = await getDB(); // an error could occur here
  let rows = await db.query("SELECT name FROM pokedex"); // or here
  // process the result rows somehow
} catch (err) {
  res.status(500).send("Something went wrong on the server. Please try again later.");
}</pre></code>
           <p class="code-caption">Node.js</p>
           <p>But we're missing something...</p>
         </section>
       <section class="font-16pt-slide">
         <h3>Handling different connection vs. query errors</h3>
         <p>Remember that you always need to close the DB connection with <code>db.end()</code></p>
         <p>
           If you have try/catch around code that does both the connection and querying, you'll have to be
           careful about whether the <code>db</code> object has actually been constructed.
         </p>
         <p>If the error occurs during <code>getDB()</code> (e.g. <code>ECONNREFUSED</code> for connection refused), <code>db</code> won't be defined, so the following will throw a <code>TypeError: Cannot read property 'end' of undefined</code></p>
         <pre><code class="font-12pt">async function queryDB() {
  let db;
  try {
    db = await getDB(); // connection error thrown in getDB();
    let qry = "SELECT name, type FROM pokedex;";
    let rows = await db.query(qry);
    console.log(rows);
  } catch (err) {
    console.log(err.message);
  }
  db.end(); // TypeError: Cannot read property 'end' of undefined
}</code></pre>
<p class="code-caption">JS</p>
<p>You can simulate a connection error by turning off MAMP or changing one of the config variables.</p>
</section>
       <section>
         <h2>A Fix: Checking a Defined <code>db</code></h2>
         <pre><code class="font-12pt">async function queryDB() {
  let db;
  try {
    db = await getDB(); // connection error thrown in getDB();
    let qry = "SELECT name, type FROM pokedex;";
    let rows = await db.query(qry);
    console.log(rows);
  } catch (err) {
    console.log(err.message);
  }
  if (db) { // only defined if getDB() returned a successfully-connected object
    db.end();
  }
}</code></pre>
<p class="code-caption">JS</p>
</section>

       <section>
         <h2>Looking Ahead</h2>
         <p>In tomorrow's section, you'll get practice creating tables in .sql files and using SQL queries in Node.js/Express.</p>
         <p>Next, we'll learn how to safely query tables that take user input (e.g. GET/POST parameters) and how to write queries that
         reference data from multiple tables!</p>
       </section>
      </div>
    </div>

    <script src="../../site/reveal/lib/js/head.min.js"></script>
    <script src="../../site/reveal/js/reveal.js"></script>

    <script>

      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // More info https://github.com/hakimel/reveal.js#dependencies
        dependencies: [
        { src: '../../site/reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
        { src: '../../site/reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: '../../site/reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        { src: '../../site/reveal/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
        { src: '../../site/reveal/plugin/zoom-js/zoom.js', async: true },
        { src: '../../site/reveal/plugin/notes/notes.js', async: true },
        { src: '../../site/reveal/plugin/search/search.js', async: true },
        { src: '../../site/reveal/plugin/print-pdf/printpdfbtn.js', async: true }
        ]
      });

    </script>
  </body>
</html>
